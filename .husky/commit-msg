#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Read commit message from file
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Minimum message length (excluding comments and blank lines)
MIN_LENGTH=10

# Remove comments and blank lines for validation
CLEAN_MSG=$(echo "$COMMIT_MSG" | sed '/^#/d' | sed '/^$/d' | head -n 1)

# Check minimum length
if [ ${#CLEAN_MSG} -lt $MIN_LENGTH ]; then
  echo "❌ Commit message is too short (minimum ${MIN_LENGTH} characters)."
  echo "Your message: '${CLEAN_MSG}'"
  echo ""
  echo "Please write a more descriptive commit message."
  exit 1
fi

# Check for common mistakes (warning only, non-blocking)
if echo "$CLEAN_MSG" | grep -qiE '^(wip|fixup|squash|todo|hack)'; then
  echo "⚠️  Warning: Commit message starts with WIP/fixup/squash/todo/hack."
  echo "Consider using a more descriptive message."
  # Continue anyway - this is just a warning
fi

# Optional: Check for conventional commits format
# Uncomment the following section to enforce conventional commits
#
# if ! echo "$CLEAN_MSG" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?: .+'; then
#   echo "❌ Commit message does not follow conventional commits format."
#   echo "Format: <type>(<scope>): <description>"
#   echo ""
#   echo "Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci, revert"
#   echo "Example: feat(auth): add user login functionality"
#   echo ""
#   echo "Your message: '${CLEAN_MSG}'"
#   exit 1
# fi

# Check for merge conflict markers (shouldn't be in commit message, but check anyway)
if echo "$COMMIT_MSG" | grep -qE '^<<<<<<< |^======= |^>>>>>>> '; then
  echo "❌ Merge conflict markers detected in commit message!"
  echo "Please resolve merge conflicts before committing."
  exit 1
fi

# Success
exit 0

