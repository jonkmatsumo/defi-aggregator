#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Track overall start time for performance monitoring
HOOK_START_TIME=$(date +%s)

echo "ğŸ” Running pre-commit checks..."
echo ""

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if there are any staged files
if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No files staged for commit."
  exit 0
fi

# Display summary of staged files
STAGED_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
echo "ğŸ“ Staged ${STAGED_COUNT} file(s) for commit"
echo ""

# Step 1: Run lint-staged for linting and formatting
echo "ğŸ“ Step 1/3: Running linting and formatting..."
LINT_START=$(date +%s)

npx lint-staged

LINT_EXIT_CODE=$?
if [ $LINT_EXIT_CODE -ne 0 ]; then
  LINT_END=$(date +%s)
  LINT_ELAPSED=$((LINT_END - LINT_START))
  echo ""
  echo "âŒ Linting/formatting failed after ${LINT_ELAPSED}s"
  echo ""
  echo "ğŸ’¡ To fix issues:"
  echo "   - Run 'npm run lint:fix' to auto-fix linting issues"
  echo "   - Run 'npm run format:fix' to auto-fix formatting issues"
  echo "   - Review the errors above and fix manually"
  echo ""
  echo "ğŸ’¡ To bypass this hook (not recommended): git commit --no-verify"
  exit 1
fi

LINT_END=$(date +%s)
LINT_ELAPSED=$((LINT_END - LINT_START))
echo "âœ… Linting and formatting passed in ${LINT_ELAPSED}s"
echo ""

# Step 2: Check for merge conflict markers
echo "ğŸ” Step 2/3: Checking for merge conflict markers..."
CONFLICT_CHECK_START=$(date +%s)

CONFLICT_FILES=""
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Check for conflict markers at the start of lines
    if grep -l "^<<<<<<< \|^======= \|^>>>>>>> " "$file" 2>/dev/null; then
      if [ -z "$CONFLICT_FILES" ]; then
        CONFLICT_FILES="$file"
      else
        CONFLICT_FILES="$CONFLICT_FILES $file"
      fi
    fi
  fi
done

if [ -n "$CONFLICT_FILES" ]; then
  CONFLICT_CHECK_END=$(date +%s)
  CONFLICT_ELAPSED=$((CONFLICT_CHECK_END - CONFLICT_CHECK_START))
  echo "âŒ Merge conflict markers detected after ${CONFLICT_ELAPSED}s"
  echo ""
  echo "Files with conflicts:"
  for file in $CONFLICT_FILES; do
    echo "  - $file"
  done
  echo ""
  echo "ğŸ’¡ Please resolve all merge conflicts before committing."
  echo "   Remove all <<<<<<<, =======, and >>>>>>> markers."
  exit 1
fi

CONFLICT_CHECK_END=$(date +%s)
CONFLICT_ELAPSED=$((CONFLICT_CHECK_END - CONFLICT_CHECK_START))
echo "âœ… No merge conflicts found (${CONFLICT_ELAPSED}s)"
echo ""

# Step 3: Run tests for related files
echo "ğŸ§ª Step 3/3: Running tests for changed files..."
TEST_START=$(date +%s)

# Determine if tests should run based on staged files
CLIENT_TEST_NEEDED=false
SERVER_TEST_NEEDED=false

# Check for client test files or related source files
if echo "$STAGED_FILES" | grep -E '^(src|tst)/.*\.(js|jsx)$' > /dev/null; then
  CLIENT_TEST_NEEDED=true
fi

# Check for server test files or related source files
if echo "$STAGED_FILES" | grep -E '^server/(src|tests)/.*\.js$' > /dev/null; then
  SERVER_TEST_NEEDED=true
fi

# Run client tests if needed
if [ "$CLIENT_TEST_NEEDED" = true ]; then
  echo "  â†’ Running client tests for changed files..."
  CLIENT_TEST_START=$(date +%s)
  
  # Use test:staged script which already uses --findRelatedTests
  # Jest will automatically detect staged files from git
  npm run test:staged
  
  CLIENT_EXIT_CODE=$?
  if [ $CLIENT_EXIT_CODE -ne 0 ]; then
    CLIENT_TEST_END=$(date +%s)
    CLIENT_ELAPSED=$((CLIENT_TEST_END - CLIENT_TEST_START))
    TEST_END=$(date +%s)
    TEST_ELAPSED=$((TEST_END - TEST_START))
    echo ""
    echo "âŒ Client tests failed after ${CLIENT_ELAPSED}s (total test time: ${TEST_ELAPSED}s)"
    echo ""
    echo "ğŸ’¡ To fix issues:"
    echo "   - Review test failures above"
    echo "   - Run 'npm test' to see full test output"
    echo "   - Fix failing tests or update them if behavior changed intentionally"
    echo ""
    echo "ğŸ’¡ To bypass this hook (not recommended): git commit --no-verify"
    exit 1
  fi
  
  CLIENT_TEST_END=$(date +%s)
  CLIENT_ELAPSED=$((CLIENT_TEST_END - CLIENT_TEST_START))
  echo "  âœ… Client tests passed in ${CLIENT_ELAPSED}s"
fi

# Run server tests if needed
if [ "$SERVER_TEST_NEEDED" = true ]; then
  echo "  â†’ Running server tests for changed files..."
  SERVER_TEST_START=$(date +%s)
  
  # Change to server directory and run tests
  # test:staged script uses --findRelatedTests which will detect staged files
  cd server || exit 1
  npm run test:staged
  
  SERVER_EXIT_CODE=$?
  cd .. || exit 1
  
  if [ $SERVER_EXIT_CODE -ne 0 ]; then
    SERVER_TEST_END=$(date +%s)
    SERVER_ELAPSED=$((SERVER_TEST_END - SERVER_TEST_START))
    TEST_END=$(date +%s)
    TEST_ELAPSED=$((TEST_END - TEST_START))
    echo ""
    echo "âŒ Server tests failed after ${SERVER_ELAPSED}s (total test time: ${TEST_ELAPSED}s)"
    echo ""
    echo "ğŸ’¡ To fix issues:"
    echo "   - Review test failures above"
    echo "   - Run 'cd server && npm test' to see full test output"
    echo "   - Fix failing tests or update them if behavior changed intentionally"
    echo ""
    echo "ğŸ’¡ To bypass this hook (not recommended): git commit --no-verify"
    exit 1
  fi
  
  SERVER_TEST_END=$(date +%s)
  SERVER_ELAPSED=$((SERVER_TEST_END - SERVER_TEST_START))
  echo "  âœ… Server tests passed in ${SERVER_ELAPSED}s"
fi

# Skip tests message if no tests were needed
if [ "$CLIENT_TEST_NEEDED" = false ] && [ "$SERVER_TEST_NEEDED" = false ]; then
  echo "  â­ï¸  No tests needed (no source/test files changed)"
fi

TEST_END=$(date +%s)
TEST_ELAPSED=$((TEST_END - TEST_START))
echo ""

# Calculate total time
HOOK_END_TIME=$(date +%s)
HOOK_TOTAL_ELAPSED=$((HOOK_END_TIME - HOOK_START_TIME))

# Display summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Pre-commit checks passed!"
echo ""
echo "ğŸ“Š Summary:"
echo "   â€¢ Files checked: ${STAGED_COUNT}"
echo "   â€¢ Linting/formatting: ${LINT_ELAPSED}s"
echo "   â€¢ Conflict check: ${CONFLICT_ELAPSED}s"
if [ "$CLIENT_TEST_NEEDED" = true ] || [ "$SERVER_TEST_NEEDED" = true ]; then
  echo "   â€¢ Testing: ${TEST_ELAPSED}s"
fi
echo "   â€¢ Total time: ${HOOK_TOTAL_ELAPSED}s"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Performance warning if hooks take too long
if [ "$HOOK_TOTAL_ELAPSED" -gt 30 ]; then
  echo "âš ï¸  Warning: Pre-commit hooks took ${HOOK_TOTAL_ELAPSED}s (target: < 30s)"
  echo "   Consider optimizing tests or running them separately for large changes."
  echo ""
fi

exit 0
